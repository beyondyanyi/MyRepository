#### Redis事件通知

发送即忘策略



##### keyspace

```
键空间通知
__keyspace@DB__:KeyPattern
或
__keyspace@DB__:OpsType

DB:第几个库
KeyPattern:需要监控的键模式（可以用通配符）
OpsType：操作类型


```



##### keyevent

```
键事件通知
__keyspace@DB__:KeyPattern
```





例如：

```
比如说，对 0 号数据库的键 mykey 执行 DEL 命令时， 系统将分发两条消息， 相当于执行以下两个 PUBLISH 命令：
    PUBLISH __keyspace@0__:sampleKey del
    PUBLISH __keyevent@0__:del sampleKey
    
订阅第一个频道 __keyspace@0__:mykey,可以接收 0 号数据库中所有修改键 mykey 的事件。
订阅第二个频道 __keyevent@0__:del,则可以接收 0 号数据库中所有执行 del 命令的键。
```



注意：

```
键空间通知通常是不启用的，因为这个过程会产生额外消耗。所以在使用该特性之前，请确认一定是要用这个特性的，然后修改配置文件。相关配置项如下：
```

| 字符 | 发送的通知                                                 |
| ---- | ---------------------------------------------------------- |
| K    | 键空间通知，所有通知以 __keyspace@<db>__ 为前缀，针对Key   |
| E    | 键事件通知，所有通知以 __keyevent@<db>__ 为前缀，针对event |
| g    | DEL 、 EXPIRE 、 RENAME 等类型无关的通用命令的通知         |
| $    | 字符串命令的通知                                           |
| l    | 列表命令的通知                                             |
| s    | 集合命令的通知                                             |
| h    | 哈希命令的通知                                             |
| z    | 有序集合命令的通知                                         |
| x    | 过期事件：每当有过期键被删除时发送                         |
| e    | 驱逐(evict)事件：每当有键因为 maxmemory 政策而被删除时发送 |
| A    | 参数 g$lshzxe 的别名，相当于是All                          |

```
	输入的参数中至少要有一个 K 或者 E ， 否则的话， 不管其余的参数是什么， 都不会有任何通知被分发。上表中紫色的部分为通用的操作或者事件，而黄色则表示特定数据类型的操作。
	配置文件中修改 notify-keyspace-events “Kx”，注意：这个双引号是一定要的，否则配置不成功，启动也不报错。
```

##### 过期通知的发送时间

```
Redis 使用以下两种方式删除过期的键：
当一个键被访问时，程序会对这个键进行检查，如果键已经过期，那么该键将被删除。
底层系统会在后台渐进地查找并删除那些过期的键，从而处理那些已经过期、但是不会被访问到的键。
当过期键被以上两个程序的任意一个发现、 并且将键从数据库中删除时， Redis 会产生一个 expired 通知。
Redis 并不保证生存时间（TTL）变为 0 的键会立即被删除： 如果程序没有访问这个过期键， 或者带有生存时间的键非常多的话， 那么在键的生存时间变为 0 ， 直到键真正被删除这中间， 可能会有一段比较显著的时间间隔。
因此， Redis 产生 expired 通知的时间为过期键被删除的时候， 而不是键的生存时间变为 0 的时候。
```

